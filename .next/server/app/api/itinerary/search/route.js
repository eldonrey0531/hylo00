"use strict";(()=>{var e={};e.id=919,e.ids=[919],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},9430:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>m,requestAsyncStorage:()=>g,routeModule:()=>l,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p});var i={};r.r(i),r.d(i,{POST:()=>u});var s=r(9303),a=r(8716),n=r(670),o=r(7070),d=r(1202),c=r(6288);async function u(e){try{d.k.log(1,"Search request received","search/route.ts","POST");let{destination:t,duration:r,budget:i,activities:s,preferences:a,topK:n=5}=await e.json();if(!t)return o.NextResponse.json({error:"Destination is required"},{status:400});d.k.log(2,"Search parameters parsed","search/route.ts","POST",{destination:t,duration:r,budget:i,activitiesCount:s?.length||0,preferencesCount:a?.length||0,topK:n});let u=await (0,c.Pg)({destination:t,duration:r?parseInt(r):void 0,budget:i,activities:s,preferences:a},n);d.k.log(4,"Similar itineraries found","search/route.ts","POST",{count:u.length,topScore:u.length>0?u[0].score:null});let l=u.map(e=>({workflowId:e.id,score:e.score,destination:e.metadata?.destination,duration:e.metadata?.duration,budget:e.metadata?.budget,activities:e.metadata?.activities||[],preferences:e.metadata?.preferences||[],createdAt:e.metadata?.timestamp,summary:e.metadata?.itinerary?{title:e.metadata.itinerary.title||`Trip to ${e.metadata?.destination}`,description:e.metadata.itinerary.description||`${e.metadata?.duration} day trip`}:null}));return o.NextResponse.json({success:!0,query:{destination:t,duration:r,budget:i,activities:s,preferences:a},results:l,count:l.length})}catch(e){return d.k.error(10,"Search request failed","search/route.ts","POST",e instanceof Error?e:String(e)),o.NextResponse.json({error:"Failed to search itineraries",details:e instanceof Error?e.message:String(e)},{status:500})}}let l=new s.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/itinerary/search/route",pathname:"/api/itinerary/search",filename:"route",bundlePath:"app/api/itinerary/search/route"},resolvedPagePath:"C:\\Users\\raze0\\Documents\\vercel_deploy\\hylo00_original\\src\\app\\api\\itinerary\\search\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:g,staticGenerationAsyncStorage:p,serverHooks:h}=l,S="/api/itinerary/search/route";function m(){return(0,n.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}},6288:(e,t,r)=>{r.d(t,{Lm:()=>o,Pg:()=>d});var i=r(6343),s=r(1202);let a=null;function n(){if(!a){let e=process.env.KV_REST_API_URL,t=process.env.KV_REST_API_TOKEN;if(!e||!t)throw s.k.error(0,"REDIS_CONFIG_MISSING","redis-vector.ts","getRedisClient","Missing Redis credentials"),Error("Missing KV_REST_API_URL or KV_REST_API_TOKEN");a=new i.s({url:e,token:t}),s.k.log(0,"REDIS_VECTOR_CLIENT_INITIALIZED","redis-vector.ts","getRedisClient")}return a}async function o(e,t){try{let r=n(),i=[t.destination.toLowerCase(),`${t.duration} days`,t.budget.toLowerCase(),...t.activities.map(e=>e.toLowerCase()),...t.preferences.map(e=>e.toLowerCase())].join(" "),a=`search:${e}`;await r.hset(a,{workflowId:e,destination:t.destination,duration:t.duration,budget:t.budget,activities:JSON.stringify(t.activities),preferences:JSON.stringify(t.preferences),searchText:i,timestamp:t.timestamp,itinerary:JSON.stringify(t.itinerary)});let o=r.pipeline();o.sadd(`idx:destination:${t.destination.toLowerCase()}`,e),o.sadd(`idx:budget:${t.budget.toLowerCase()}`,e);let d=c(t.duration);return o.sadd(`idx:duration:${d}`,e),t.activities.forEach(t=>{o.sadd(`idx:activity:${t.toLowerCase()}`,e)}),o.sadd("idx:all",e),await o.exec(),s.k.log(201,"ITINERARY_SEARCH_DATA_STORED","redis-vector.ts","storeItineraryForSearch",{workflowId:e,destination:t.destination}),!0}catch(t){return s.k.error(202,"ITINERARY_SEARCH_STORE_FAILED","redis-vector.ts","storeItineraryForSearch",t instanceof Error?t:String(t),{workflowId:e}),!1}}async function d(e,t=5){try{let r;let i=n(),a=[];if(e.destination&&a.push(`idx:destination:${e.destination.toLowerCase()}`),e.budget&&a.push(`idx:budget:${e.budget.toLowerCase()}`),e.duration){let t=c(e.duration);a.push(`idx:duration:${t}`)}if(e.activities&&e.activities.length>0&&e.activities.forEach(e=>{a.push(`idx:activity:${e.toLowerCase()}`)}),0===a.length)r=await i.smembers("idx:all");else if(1===a.length)r=await i.smembers(a[0]);else{let e=await Promise.all(a.map(e=>i.smembers(e)));r=e.length>0?e[0].filter(t=>e.every(e=>e.includes(t))):[]}let o=[];for(let s of r.slice(0,t)){let t=await i.hgetall(`search:${s}`);t&&Object.keys(t).length>0&&o.push({id:s,score:function(e,t){let r,i=0;if(r=.4,e.destination&&t.destination&&t.destination.toLowerCase().includes(e.destination.toLowerCase())&&(i+=.4),r+=.3,e.budget&&t.budget&&t.budget.toLowerCase()===e.budget.toLowerCase()&&(i+=.3),r+=.2,e.duration&&t.duration){let r=Math.abs(e.duration-parseInt(t.duration));0===r?i+=.2:r<=2&&(i+=.1)}if(r+=.1,e.activities&&t.activities){let r=e.activities.map(e=>e.toLowerCase()),s=JSON.parse(t.activities).map(e=>e.toLowerCase()),a=r.filter(e=>s.includes(e)).length;a>0&&(i+=a/Math.max(r.length,s.length)*.1)}return r>0?i/r:0}(e,t),metadata:{destination:t.destination,duration:parseInt(t.duration),budget:t.budget,activities:JSON.parse(t.activities),preferences:JSON.parse(t.preferences),timestamp:t.timestamp,itinerary:JSON.parse(t.itinerary)}})}return o.sort((e,t)=>t.score-e.score),s.k.log(203,"SIMILAR_ITINERARIES_FOUND","redis-vector.ts","searchSimilarItineraries",{resultsCount:o.length,topK:t}),o.slice(0,t)}catch(e){return s.k.error(204,"SIMILAR_ITINERARIES_SEARCH_FAILED","redis-vector.ts","searchSimilarItineraries",e instanceof Error?e:String(e)),[]}}function c(e){return e<=3?"short":e<=7?"week":e<=14?"long":"extended"}},1202:(e,t,r)=>{var i,s,a,n,o;r.d(t,{k:()=>c}),function(e){e.USD="USD",e.EUR="EUR",e.GBP="GBP",e.CAD="CAD",e.AUD="AUD"}(i||(i={})),function(e){e.TOTAL="total",e.PER_PERSON="per-person"}(s||(s={})),function(e){e.PENDING="pending",e.PROCESSING="processing",e.COMPLETE="complete",e.ERROR="error"}(a||(a={})),function(e){e.SUCCESS="Success",e.ERROR="Error",e.WARNING="Warning"}(n||(n={})),function(e){e.HIGH="High",e.MEDIUM="Medium",e.LOW="Low"}(o||(o={}));class d{static instance;logLevel;logs=[];maxLogs=1e3;constructor(){this.logLevel=process.env.ITINERARY_LOG_LEVEL||"info"}static getInstance(){return d.instance||(d.instance=new d),d.instance}shouldLog(e){let t=["silent","error","warn","info","debug"],r=t.indexOf(this.logLevel);return t.indexOf(e)<=r}log(e,t,r,i,s={},a,o=n.SUCCESS){if(!this.shouldLog("info"))return;let d={stepNumber:e,action:t,fileName:r,functionName:i,timestamp:new Date().toISOString(),data:s,...void 0!==a&&{duration:a},status:o};this.logs.push(d),this.logs.length>this.maxLogs&&this.logs.shift();try{console.log(`Step ${e}: ${t} in ${r} - ${i}`,d)}catch(r){console.error(`Step ${e}: Logging failed for ${t}`,{error:r instanceof Error?r.message:String(r)})}}error(e,t,r,i,s,a={}){if(!this.shouldLog("error"))return;let o=s instanceof Error?s.message:s;this.log(e,t,r,i,{...a,error:o},void 0,n.ERROR)}warn(e,t,r,i,s,a={}){this.shouldLog("warn")&&this.log(e,t,r,i,{...a,warning:s},void 0,n.WARNING)}debug(e,t,r,i,s={}){this.shouldLog("debug")&&this.log(e,`DEBUG: ${t}`,r,i,s,void 0,n.SUCCESS)}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}}let c=d.getInstance()}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[948,972,343],()=>r(9430));module.exports=i})();