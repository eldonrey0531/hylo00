"use strict";(()=>{var e={};e.id=604,e.ids=[604],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},4175:e=>{e.exports=require("tty")},1764:e=>{e.exports=require("util")},2761:e=>{e.exports=require("node:async_hooks")},6005:e=>{e.exports=require("node:crypto")},2033:e=>{e.exports=require("node:module")},7354:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>V,patchFetch:()=>Z,requestAsyncStorage:()=>J,routeModule:()=>z,serverHooks:()=>M,staticGenerationAsyncStorage:()=>H});var n={};i.r(n),i.d(n,{GET:()=>B,POST:()=>W,PUT:()=>G});var r=i(9303),s=i(8716),a=i(670),o=i(3393),l=i(9268),u=i(2783),c=i(5777),d=i(7484);let h=(e,t)=>{if(Object.values(e).includes(t))return t};var p=i(8993),g=i(7490),y=i(8768),f=i(9212),m=i(3998),v=i(9038),w=class{timings={};start(e,t){this.timings[e]||(this.timings[e]={description:t??"",timers:[]});let i=this.timings[e].timers.push({start:Date.now()})-1;return()=>{let t=this.timings[e];if(!t)return console.warn(`Timing "${e}" does not exist`);let n=t.timers[i];if(!n)return console.warn(`Timer ${i} for timing "${e}" does not exist`);n.end=Date.now()}}append(e,t){this.timings[e]={description:t,timers:[]}}async wrap(e,t,i){let n=this.start(e,i);try{return await (0,v.qN)(t)}finally{n()}}getHeader(){return Object.entries(this.timings).reduce((e,[t,{description:i,timers:n}])=>{if(!n.some(e=>e.end))return e;let r=n.reduce((e,{start:t,end:i})=>t&&i?e+(i-t):e,0);return[...e,[t,i?`desc="${i}"`:"",r?`dur=${r}`:""].filter(Boolean).join(";")]},[]).join(", ")}};let I=e=>{let t;let i=new Promise(e=>{t=e}),n=e?.interval??3e3,r=e?.value??" ";return new Promise(async(e,s)=>{try{let s=new ReadableStream({start(e){let i=new TextEncoder,s=setInterval(()=>{e.enqueue(i.encode(r))},n);t(t=>{clearInterval(s),Promise.resolve(t).then(t=>{e.enqueue(i.encode((0,c.Pz)(t))),e.close()})})}});e({stream:s,finalize:await i})}catch(e){s(e)}})};var S=i(9092),b=i(1744);let _=b.z.object({status:b.z.number().default(200),skipped:b.z.boolean().optional().default(!1),modified:b.z.boolean().optional().default(!1),error:b.z.string().default("Successfully registered")});var k=class{id;handler;inngestRegisterUrl;frameworkName;signingKey;signingKeyFallback;_mode;fetch;_serveHost;_servePath;logLevel;streaming;rawFns;client;fns={};env=(0,o.gx)();allowExpiredSignatures;_options;skipSignatureValidation;constructor(e){if(this._options=e,Object.hasOwn(e,"eventKey"))throw Error(`${l.Ap} You've passed an Inngest client as the first argument to your serve handler. This is no longer supported in v3; please pass the Inngest client as the \`client\` property of an options object instead. See https://www.inngest.com/docs/sdk/migration`);this.frameworkName=e.frameworkName,this.client=e.client,e.id&&console.warn(`${l.Ap} The \`id\` serve option is deprecated and will be removed in v4`),this.id=e.id||this.client.id,this.handler=e.handler,this.allowExpiredSignatures=!!arguments[0]?.__testingAllowExpiredSignatures,this.rawFns=e.functions.filter(Boolean),this.rawFns.length!==e.functions.length&&console.warn("Some functions passed to serve() are undefined and misconfigured.  Please check your imports."),this.fns=this.rawFns.reduce((e,t)=>{let i=t.getConfig({baseUrl:new URL("https://example.com"),appPrefix:this.id}),n=i.reduce((e,{id:i},n)=>({...e,[i]:{fn:t,onFailure:!!n}}),{});return i.forEach(({id:t})=>{if(e[t])throw Error(`Duplicate function ID "${t}"; please change a function's name or provide an explicit ID to avoid conflicts.`)}),{...e,...n}},{}),this.inngestRegisterUrl=new URL("/fn/register",this.apiBaseUrl),this.signingKey=e.signingKey,this.signingKeyFallback=e.signingKeyFallback,this._serveHost=e.serveHost||this.env[l.hZ.InngestServeHost],this._servePath=e.servePath||this.env[l.hZ.InngestServePath],this.skipSignatureValidation=e.skipSignatureValidation||!1;let t="info";this.logLevel=b.z.enum(g._i).default(t).catch(e=>(this.log("warn",`Unknown log level passed: ${String(e.input)}; defaulting to ${t}`),t)).parse(e.logLevel||this.env[l.hZ.InngestLogLevel]),"debug"===this.logLevel&&S.enable&&"function"==typeof S.enable&&S.enable(`${l.g8}:*`),this.streaming=b.z.union([b.z.enum(["allow","force"]),b.z.literal(!1)]).default(!1).catch(e=>(this.log("warn",`Unknown streaming option passed: ${String(e.input)}; defaulting to ${String(!1)}`),!1)).parse(e.streaming||this.env[l.hZ.InngestStreaming]),this.fetch=e.fetch?(0,o.wY)(e.fetch):this.client.fetch}get apiBaseUrl(){return this._options.baseUrl||this.env[l.hZ.InngestApiBaseUrl]||this.env[l.hZ.InngestBaseUrl]||this.client.apiBaseUrl||l.Bh}get eventApiBaseUrl(){return this._options.baseUrl||this.env[l.hZ.InngestEventApiBaseUrl]||this.env[l.hZ.InngestBaseUrl]||this.client.eventBaseUrl||l.xk}get serveHost(){return this._serveHost||this.env[l.hZ.InngestServeHost]}get servePath(){return this._servePath||this.env[l.hZ.InngestServePath]}get hashedEventKey(){if(this.client.eventKey&&this.client.eventKey!==l.V5)return(0,c.h2)(this.client.eventKey)}get hashedSigningKey(){if(this.signingKey)return(0,c.sQ)(this.signingKey)}get hashedSigningKeyFallback(){if(this.signingKeyFallback)return(0,c.sQ)(this.signingKeyFallback)}async shouldStream(e){return await e.queryStringWithDefaults("testing for probe",l.ad.Probe)===void 0&&!!e.transformStreamingResponse&&("force"===this.streaming||"allow"===this.streaming&&(0,o.Ih)(this.frameworkName,this.env))}createHandler(){let e=async(...e)=>{let t=new w,i=e[e.length-1],n="object"==typeof i&&null!==i&&"actionOverrides"in i&&"object"==typeof i.actionOverrides&&null!==i.actionOverrides?i.actionOverrides:{},r={...Object.entries({...await t.wrap("handler",()=>this.handler(...e)).catch((0,p.LB)("Serve handler failed to run")),...n}).reduce((e,[t,i])=>"function"!=typeof i?e:{...e,[t]:(e,...n)=>{let r=[`Failed calling \`${t}\` from serve handler`,e].filter(Boolean).join(" when ");return(0,v.qN)(()=>i(...n)).catch((0,p.LB)(r)).catch(e=>{throw this.log("error",e),e})}},{}),queryStringWithDefaults:async(e,t)=>{let i=await r.url(e);return await r.queryString?.(e,t,i)||i.searchParams.get(t)||void 0},...n},[s,a]=await Promise.all([r.env?.("starting to handle request"),r.headers("checking expected server kind",l.cW.InngestServerKind)]);this.env={...(0,o.gx)(),...s};let u=()=>(0,o.vS)({env:this.env,framework:this.frameworkName,client:this.client,expectedServerKind:a||void 0,extras:{"Server-Timing":t.getHeader()}}),d=(0,o.iJ)({env:this.env,client:this.client});if(d.isExplicit)this._mode=d;else{let e=await r.isProduction?.("starting to handle request");"boolean"==typeof e?this._mode=new o.AR({type:e?"cloud":"dev",isExplicit:!1}):this._mode=d}this.upsertKeysFromEnv();let h=r.method("starting to handle request"),g=[l.cW.TraceParent,l.cW.TraceState].map(async e=>{let t=await r.headers(`fetching ${e} for forwarding`,e);return{header:e,value:t}}),f=await r.headers("checking signature for request",l.cW.ContentLength).then(e=>{if(e)return Number.parseInt(e,10)}),[m,S,b]=await Promise.all([r.headers("checking signature for request",l.cW.Signature).then(e=>e??void 0),h,h.then(e=>("POST"===e||"PUT"===e)&&f?r.body(`checking body for request signing as method is ${e}`):"")]),_=this.validateSignature(m,b),k=Promise.all(g).then(e=>e.reduce((e,{header:t,value:i})=>(i&&(e[t]=i),e),{})),A=t.wrap("action",()=>this.handleAction({actions:r,timer:t,getInngestHeaders:u,reqArgs:e,signatureValidation:_,body:b,method:S,headers:k})),E=async e=>{let t;let i={...u(),...await k,...e.headers,...null===e.version?{}:{[l.cW.RequestVersion]:(e.version??y.I).toString()}};try{t=await _.then(t=>{if(t.success&&t.keyUsed)return this.getResponseSignature(t.keyUsed,e.body)})}catch(t){return{...e,headers:i,body:(0,c.Pz)((0,p.Xy)(t)),status:500}}return t&&(i[l.cW.Signature]=t),{...e,headers:i}};if(await this.shouldStream(r)&&await r.method("starting streaming response")==="POST"){let{stream:e,finalize:i}=await I();return A.then(e=>i(E(e))),t.wrap("res",()=>r.transformStreamingResponse?.("starting streaming response",{status:201,headers:u(),body:e,version:null}))}return t.wrap("res",async()=>A.then(E).then(e=>r.transformResponse("sending back response",e)))};return Object.defineProperties(e,{name:{value:"InngestHandler"},length:{value:this.handler.length}}),e}get mode(){return this._mode}set mode(e){this._mode=e,e&&(this.client.mode=e)}async handleAction({actions:e,timer:t,getInngestHeaders:i,reqArgs:n,signatureValidation:r,body:s,method:a,headers:u}){let d=void 0===s;try{let y=await e.url("starting to handle request");if("POST"===a){if(d)return this.log("error","Missing body when executing, possibly due to missing request body middleware"),{status:500,headers:{"Content-Type":"application/json"},body:(0,c.Pz)((0,p.Xy)(Error("Missing request body when executing, possibly due to missing request body middleware"))),version:void 0};let i=await r;if(!i.success)return{status:401,headers:{"Content-Type":"application/json"},body:(0,c.Pz)((0,p.Xy)(i.err)),version:void 0};let a=await e.queryStringWithDefaults("testing for probe",l.ad.Probe);if(a){let e=h(l.lD,a);if(!e)return{status:400,headers:{"Content-Type":"application/json"},body:(0,c.Pz)((0,p.Xy)(Error(`Unknown probe "${a}"`))),version:void 0};return({[l.lD.Trust]:()=>({status:200,headers:{"Content-Type":"application/json"},body:"",version:void 0})})[e]()}let o=await e.queryStringWithDefaults("processing run request",l.ad.FnId);if(!o)throw Error("No function ID found in request");let g=await e.queryStringWithDefaults("processing run request",l.ad.StepId)||null,{version:y,result:m}=this.runStep({functionId:o,data:s,stepId:g,timer:t,reqArgs:n,headers:await u}),v=await m,w=e=>(e.data=(0,f.gL)(e.data),e),I={"function-rejected":e=>({status:e.retriable?500:400,headers:{"Content-Type":"application/json",[l.cW.NoRetry]:e.retriable?"false":"true",..."string"==typeof e.retriable?{[l.cW.RetryAfter]:e.retriable}:{}},body:(0,c.Pz)((0,f.gL)(e.error)),version:y}),"function-resolved":e=>({status:200,headers:{"Content-Type":"application/json"},body:(0,c.Pz)((0,f.gL)(e.data)),version:y}),"step-not-found":e=>({status:500,headers:{"Content-Type":"application/json",[l.cW.NoRetry]:"false"},body:(0,c.Pz)({error:`Could not find step "${e.step.displayName||e.step.id}" to run; timed out`}),version:y}),"step-ran":e=>{let t=w(e.step);return{status:206,headers:{"Content-Type":"application/json",...void 0!==e.retriable?{[l.cW.NoRetry]:e.retriable?"false":"true",..."string"==typeof e.retriable?{[l.cW.RetryAfter]:e.retriable}:{}}:{}},body:(0,c.Pz)([t]),version:y}},"steps-found":e=>{let t=e.steps.map(w);return{status:206,headers:{"Content-Type":"application/json"},body:(0,c.Pz)(t),version:y}}}[v.type];try{return await I(v)}catch(e){throw this.log("error","Error handling execution result",e),e}}let m=i()[l.cW.Environment]??null;if("GET"===a)return{status:200,body:(0,c.Pz)(await this.introspectionBody({actions:e,env:m,signatureValidation:r,url:y})),headers:{"Content-Type":"application/json"},version:void 0};if("PUT"===a){let[t,n]=await Promise.all([e.queryStringWithDefaults("processing deployment request",l.ad.DeployId).then(e=>"undefined"===e?void 0:e),Promise.resolve((0,o.AE)(this.env[l.hZ.InngestAllowInBandSync])).then(t=>void 0===t||t?e.headers("processing deployment request",l.cW.InngestSyncKind):l.q_.OutOfBand).then(e=>e===l.q_.InBand)]);if(n){if(d)return this.log("error","Missing body when syncing, possibly due to missing request body middleware"),{status:500,headers:{"Content-Type":"application/json"},body:(0,c.Pz)((0,p.Xy)(Error("Missing request body when syncing, possibly due to missing request body middleware"))),version:void 0};if(!(await r).success)return{status:401,body:(0,c.Pz)({code:"sig_verification_failed"}),headers:{"Content-Type":"application/json"},version:void 0};let i=g.ej.safeParse(s);if(!i.success)return{status:400,body:(0,c.Pz)({code:"invalid_request",message:i.error.message}),headers:{"Content-Type":"application/json"},version:void 0};y=this.reqUrl(new URL(i.data.url));let n=await this.inBandRegisterBody({actions:e,deployId:t,env:m,signatureValidation:r,url:y});return{status:200,body:(0,c.Pz)(n),headers:{"Content-Type":"application/json",[l.cW.InngestSyncKind]:l.q_.InBand},version:void 0}}let{status:a,message:u,modified:h}=await this.register(this.reqUrl(y),t,i);return{status:a,body:(0,c.Pz)({message:u,modified:h}),headers:{"Content-Type":"application/json",[l.cW.InngestSyncKind]:l.q_.OutOfBand},version:void 0}}}catch(e){return{status:500,body:(0,c.Pz)({type:"internal",...(0,p.Xy)(e)}),headers:{"Content-Type":"application/json"},version:void 0}}return{status:405,body:JSON.stringify({message:"No action found; request was likely not POST, PUT, or GET",mode:this._mode}),headers:{},version:void 0}}runStep({functionId:e,stepId:t,data:i,timer:n,reqArgs:r,headers:s}){let a=this.fns[e];if(!a)throw Error(`Could not find function with ID "${e}"`);let o=(0,f.lz)(i),{version:u}=o;u===l.N7.V1&&a.fn.shouldOptimizeParallelism?.()&&(u=l.N7.V2);let c=(0,v.qN)(async()=>{let e=await (0,f.si)({data:o,api:this.client.inngestApi,version:u});if(!e.ok)throw Error(e.error);let i=await ({[l.N7.V0]:({event:e,events:i,steps:o,ctx:l,version:u})=>{let c=Object.entries(o??{}).reduce((e,[t,i])=>({...e,[t]:{id:t,data:i}}),{});return{version:u,partialOptions:{client:this.client,runId:l?.run_id||"",data:{event:e,events:i,runId:l?.run_id||"",attempt:l?.attempt??0},stepState:c,requestedRunStep:"step"===t?void 0:t||void 0,timer:n,isFailureHandler:a.onFailure,stepCompletionOrder:l?.stack?.stack??[],reqArgs:r,headers:s}}},[l.N7.V1]:({event:e,events:i,steps:o,ctx:l,version:u})=>{let c=Object.entries(o??{}).reduce((e,[t,i])=>({...e,[t]:"data"===i.type?{id:t,data:i.data}:"input"===i.type?{id:t,input:i.input}:{id:t,error:i.error}}),{});return{version:u,partialOptions:{client:this.client,runId:l?.run_id||"",data:{event:e,events:i,runId:l?.run_id||"",attempt:l?.attempt??0},stepState:c,requestedRunStep:"step"===t?void 0:t||void 0,timer:n,isFailureHandler:a.onFailure,disableImmediateExecution:l?.disable_immediate_execution,stepCompletionOrder:l?.stack?.stack??[],reqArgs:r,headers:s}}},[l.N7.V2]:({event:e,events:i,steps:o,ctx:l,version:u})=>{let c=Object.entries(o??{}).reduce((e,[t,i])=>({...e,[t]:"data"===i.type?{id:t,data:i.data}:"input"===i.type?{id:t,input:i.input}:{id:t,error:i.error}}),{});return{version:u,partialOptions:{client:this.client,runId:l?.run_id||"",data:{event:e,events:i,runId:l?.run_id||"",attempt:l?.attempt??0},stepState:c,requestedRunStep:"step"===t?void 0:t||void 0,timer:n,isFailureHandler:a.onFailure,disableImmediateExecution:l?.disable_immediate_execution,stepCompletionOrder:l?.stack?.stack??[],reqArgs:r,headers:s}}}})[u](e.value);return a.fn.createExecution(i).start()});return{version:u,result:c}}configs(e){let t=Object.values(this.rawFns).reduce((t,i)=>[...t,...i.getConfig({baseUrl:e,appPrefix:this.id})],[]);for(let e of t){let t=g.eb.safeParse(e);if(!t.success){let i=t.error.errors.map(e=>e.message).join("; ");this.log("warn",`Config invalid for function "${e.id}" : ${i}`)}}return t}reqUrl(e){let t=new URL(e),i=this.serveHost||this.env[l.hZ.InngestServeHost],n=this.servePath||this.env[l.hZ.InngestServePath];return n&&(t.pathname=n),i&&(t=new URL(t.pathname+t.search,i)),t}registerBody({url:e,deployId:t}){return{url:e.href,deployType:"ping",framework:this.frameworkName,appName:this.id,functions:this.configs(e),sdk:`js:v${u.i}`,v:"0.1",deployId:t||void 0,capabilities:{trust_probe:"v1",connect:"v1"},appVersion:this.client.appVersion}}async inBandRegisterBody({actions:e,deployId:t,env:i,signatureValidation:n,url:r}){let s=this.registerBody({deployId:t,url:r}),a=await this.introspectionBody({actions:e,env:i,signatureValidation:n,url:r}),l={app_id:this.id,appVersion:this.client.appVersion,capabilities:s.capabilities,env:i,framework:s.framework,functions:s.functions,inspection:a,platform:(0,o.y8)({...(0,o.gx)(),...this.env}),sdk_author:"inngest",sdk_language:"",sdk_version:"",sdk:s.sdk,url:s.url};return a.authentication_succeeded&&(l.sdk_language=a.sdk_language,l.sdk_version=a.sdk_version),l}async introspectionBody({actions:e,env:t,signatureValidation:i,url:n}){let r=this.registerBody({url:this.reqUrl(n),deployId:null});if(!this._mode)throw Error("No mode set; cannot introspect without mode");let s={authentication_succeeded:null,extra:{is_mode_explicit:this._mode.isExplicit},has_event_key:this.client.eventKeySet(),has_signing_key:!!this.signingKey,function_count:r.functions.length,mode:this._mode.type,schema_version:"2024-05-24"};if("cloud"===this._mode.type)try{if(!(await i).success)throw Error("Signature validation failed");s={...s,authentication_succeeded:!0,api_origin:this.apiBaseUrl,app_id:this.id,capabilities:{trust_probe:"v1",connect:"v1"},env:t,event_api_origin:this.eventApiBaseUrl,event_key_hash:this.hashedEventKey??null,extra:{...s.extra,is_streaming:await this.shouldStream(e)},framework:this.frameworkName,sdk_language:"js",sdk_version:u.i,serve_origin:this.serveHost??null,serve_path:this.servePath??null,signing_key_fallback_hash:this.hashedSigningKeyFallback??null,signing_key_hash:this.hashedSigningKey??null}}catch{s={...s,authentication_succeeded:!1}}return s}async register(e,t,i){let n,r,s,a,u;let h=this.registerBody({url:e,deployId:t}),p=new URL(this.inngestRegisterUrl.href);if(this._mode&&this._mode.isInferred&&this._mode.isDev){let e=(0,o.U5)(this.env);await (0,d.D)(e,this.fetch)&&(p=(0,d.W)(e,"/fn/register"))}else this._mode?.explicitDevUrl&&(p=(0,d.W)(this._mode.explicitDevUrl.href,"/fn/register"));t&&p.searchParams.set(l.ad.DeployId,t);try{n=await (0,m.c)({authToken:this.hashedSigningKey,authTokenFallback:this.hashedSigningKeyFallback,fetch:this.fetch,url:p.href,options:{method:"POST",body:(0,c.Pz)(h),headers:{...i(),[l.cW.InngestSyncKind]:l.q_.OutOfBand},redirect:"follow"}})}catch(e){return this.log("error",e),{status:500,message:`Failed to register${e instanceof Error?`; ${e.message}`:""}`,modified:!1}}let g=await n.text(),y={};try{y=JSON.parse(g)}catch(t){this.log("warn","Couldn't unpack register response:",t);let e="Failed to register";return t instanceof Error&&(e+=`; ${t.message}`),{status:500,message:e+=`; status code: ${n.status}`,modified:!1}}try{({status:r,error:s,skipped:a,modified:u}=_.parse(y))}catch(t){this.log("warn","Invalid register response schema:",t);let e="Failed to register";return t instanceof Error&&(e+=`; ${t.message}`),{status:500,message:e+=`; status code: ${n.status}`,modified:!1}}return a||this.log("debug","registered inngest functions:",n.status,n.statusText,y),{status:r,message:s,modified:u}}upsertKeysFromEnv(){this.env[l.hZ.InngestSigningKey]&&(this.signingKey||(this.signingKey=String(this.env[l.hZ.InngestSigningKey])),this.client.inngestApi.setSigningKey(this.signingKey)),this.env[l.hZ.InngestSigningKeyFallback]&&(this.signingKeyFallback||(this.signingKeyFallback=String(this.env[l.hZ.InngestSigningKeyFallback])),this.client.inngestApi.setSigningKeyFallback(this.signingKeyFallback)),!this.client.eventKeySet()&&this.env[l.hZ.InngestEventKey]&&this.client.setEventKey(String(this.env[l.hZ.InngestEventKey])),this.env[l.hZ.InngestDevServerUrl]&&this.log("warn",`Use of ${l.hZ.InngestDevServerUrl} has been deprecated in v3; please use ${l.hZ.InngestBaseUrl} instead. See https://www.inngest.com/docs/sdk/migration`)}async validateSignature(e,t){try{if(this.skipSignatureValidation||this._mode&&!this._mode.isCloud)return{success:!0,keyUsed:""};if(!this.signingKey)throw Error(`No signing key found in client options or ${l.hZ.InngestSigningKey} env var. Find your keys at https://app.inngest.com/secrets`);if(!e)throw Error(`No ${l.cW.Signature} provided`);return{success:!0,keyUsed:new A(e).verifySignature({body:t,allowExpiredSignatures:this.allowExpiredSignatures,signingKey:this.signingKey,signingKeyFallback:this.signingKeyFallback})}}catch(e){return{success:!1,err:e}}}getResponseSignature(e,t){let i=Date.now(),n=(0,m.P)(t,e,i.toString());return`t=${i}&s=${n}`}log(e,...t){let i=["debug","info","warn","error","fatal","silent"],n=i.indexOf(this.logLevel);if(i.indexOf(e)>=n){let i=console.log;Object.hasOwn(console,e)&&(i=console[e]),i(`${l.Ap} ${e} -`,...t)}}},A=class{timestamp;signature;constructor(e){let t=new URLSearchParams(e);if(this.timestamp=t.get("t")||"",this.signature=t.get("s")||"",!this.timestamp||!this.signature)throw Error(`Invalid ${l.cW.Signature} provided`)}hasExpired(e){return!e&&Date.now()-new Date(1e3*Number.parseInt(this.timestamp)).valueOf()>3e5}#e({body:e,signingKey:t,allowExpiredSignatures:i}){if(this.hasExpired(i))throw Error("Signature has expired");if((0,m.P)(e,t,this.timestamp)!==this.signature)throw Error("Invalid signature")}verifySignature({body:e,signingKey:t,signingKeyFallback:i,allowExpiredSignatures:n}){try{return this.#e({body:e,signingKey:t,allowExpiredSignatures:n}),t}catch(t){if(!i)throw t;return this.#e({body:e,signingKey:i,allowExpiredSignatures:n}),i}}};let E=e=>"object"==typeof e&&null!==e,T=e=>"function"==typeof e,x=e=>E(e)&&T(e.setHeader)&&T(e.status)&&T(e.send);var O=i(9435),N=i(3671),R=i(1202),P=i(8227),$=i(6288);let D=e=>{if("string"!=typeof e)return null;let t=e.trim();return t.length>0?t:null},C=e=>{if(Array.isArray(e))return e.map(e=>D(e)??null).filter(e=>!!e);let t=D(e);return t?[t]:[]},K=e=>e.replace(/[-_]+/g," ").replace(/\s+/g," ").trim(),L=e=>e.map(e=>e??"").map(e=>e.replace(/\s+/g," ").trim()).filter(Boolean).join(" "),U=e=>{let t=[],i=D(e.location)??"your destination",n=D(e.tripNickname)||D((e.travelStyleAnswers??{}).tripNickname),r=e.travelStyleAnswers??{},s=C(r.vibes).map(K),a=C(r.sampleDays).map(K),o=C(r.dinnerChoices).map(K),l=D(r.otherDinnerChoiceText??null)??void 0,u=D(r.customVibesText??null),c=D(e.departDate),d=D(e.returnDate),h="number"==typeof e.plannedDays?e.plannedDays:null,p="number"==typeof e.children?e.children:0,g="number"==typeof e.adults?e.adults:0,y=C(e.selectedGroups).map(K),f=D(e.customGroupText),m=y.map(e=>"other"===e.toLowerCase()&&f?f:e).join(", "),v=C(e.selectedInterests).map(K),w=D(e.customInterestsText),I=v.map(e=>"other"===e.toLowerCase()&&w?w:e).join(", "),S=C(e.selectedInclusions).map(K).join(", "),b=D(e.customInclusionsText),_="number"==typeof e.budget?e.budget:null,k=D(e.currency),A=!0===e.flexibleBudget,E=e.diningPreferences,T=c&&d?`${c} – ${d}`:h?`${h}-day outline`:"your time in destination";t.push({title:`Shape each day in ${i}`,description:L([`Sketch a high-level plan for ${T} so you balance must-see moments with relaxed time.`,s.length>0?`Lean into the ${s.join(", ")} vibe when choosing activities.`:null,u?`Keep the "${u}" energy in mind as you confirm experiences.`:null,a.length>0?`Let your preferred ${a.join(", ")} rhythm guide how you pace mornings, afternoons, and evenings.`:null,n?`Use "${n}" as a north star when you describe the trip to partners or guests.`:null])||`Build a flexible outline for ${T} to keep your plans intentional and on-brand.`}),t.push({title:"Lock in memorable dining",description:L([o.length>0?`Reserve restaurants that match your ${o.join(", ")} preferences.`:null,l?`Call ahead with special notes like "${l}" so teams can personalize service.`:null,E?.dietaryRestrictions?`Highlight dietary needs (${JSON.stringify(E.dietaryRestrictions)}) when booking.`:null,E?.favoriteCuisines?`Feature favorite cuisines such as ${C(E.favoriteCuisines).join(", ")}.`:null,"Mix local staples with a memorable splurge meal to create contrast throughout the trip."])||"Plan a blend of local favorites and signature meals, capturing any dietary notes so reservations feel personal."}),t.push({title:"Design for your travel party",description:L([g>0?`Coordinate logistics for ${g} adult${1===g?"":"s"}, making arrival and check-in seamless.`:null,p>0?`Schedule daily downtime so ${1===p?"your child":"the kids"} can reset between anchor activities.`:null,m?`Choose experiences that resonate with ${m.toLowerCase()} to keep everyone engaged.`:null,I?`Prioritize highlights connected to ${I.toLowerCase()} when finalizing reservations.`:null,S?`Double-check that must-have inclusions (${S.toLowerCase()}) appear in each day.`:null,b?`Note custom requests like ${b} in supplier briefs.`:null])||"Balance active experiences with intentional rest blocks so the whole group stays energized and excited."});let x=[A?"Use your flexible budget to contrast premium moments with approachable local finds.":null,!A&&_?`Track spend against roughly ${k??"USD"} ${_.toLocaleString()} so you can flag overages early.`:null,e.indicator?`Keep the "${e.indicator}" focus front-and-center when prioritizing upgrades.`:null];for(x.filter(Boolean).length>0&&t.push({title:"Stay ahead of logistics & spend",description:L(x)||"Plan logistics and budget checkpoints before you depart."});t.length<3;)t.push({title:"Keep the journey effortless",description:"Confirm transportation, meal pacing, and daily highlights 48 hours in advance so the itinerary feels concierge-crafted."});return t},j=(e,t)=>{if(!Array.isArray(e))return t;let i=e.map((e,t)=>{if("string"==typeof e){let i=e.trim();return i?{title:`Trip tip ${t+1}`,description:i}:null}if("object"!=typeof e||null===e)return null;let i=D(e.title)||D(e.heading)||`Trip tip ${t+1}`,n=D(e.description)||D(e.content)||C(e.bullets).join(" ");return n?{title:i,description:n}:null}).filter(e=>!!e);return i.length>0?i:t},q=(e,t)=>{let i=U(t),n=j(e?.travelTips,i),r={...e??{}};return"nextSteps"in r&&delete r.nextSteps,{...r,travelTips:n}},F=O.$C.createFunction({id:"itinerary.generate",name:"Generate AI Itinerary",retries:3},{event:"itinerary.generate.requested"},async({event:e,step:t})=>{let{formData:i,sessionId:n,workflowId:r}=e.data,s=new Date().toISOString();R.k.log(14,"INNGEST_WORKFLOW_STARTED","inngest/functions/itinerary.ts","itineraryWorkflow",{workflowId:r,sessionId:n,location:i.location,adults:i.adults}),await t.run("initialize-workflow-state",async()=>{R.k.log(13,"WORKFLOW_STATE_INITIALIZATION_STARTED","inngest/functions/itinerary.ts","initializeWorkflowState",{workflowId:r,sessionId:n});let e=await N.U.storeItineraryState({workflowId:r,sessionId:n,status:"processing",formData:i,itinerary:void 0,rawItinerary:void 0,createdAt:s,updatedAt:s});R.k.log(13,"WORKFLOW_STATE_INITIALIZATION_RESULT","inngest/functions/itinerary.ts","initializeWorkflowState",{workflowId:r,sessionId:n,initialized:e})});let a=await t.run("ai-itinerary-architect",async()=>{R.k.log(15,"AI_ARCHITECT_STARTED","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,destination:i.location,adults:i.adults,children:i.children??0});let e=(0,P.M)(i);R.k.log(15,"AI_PROMPT_PREVIEW","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,promptLength:e.length,promptPreview:e.slice(0,1200)});let t="grok-4-fast-reasoning";R.k.log(15,"XAI_MODEL_INITIALIZED","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,model:t,apiKeyPresent:!!process.env.XAI_API_KEY,apiKeyLength:process.env.XAI_API_KEY?.length??0});let n=Date.now();try{R.k.log(15,"XAI_REQUEST_DISPATCHED","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,model:t,promptCharacters:e.length});let s=await (0,P.y)({prompt:e,model:t});R.k.log(16,"XAI_RESPONSE_METADATA","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,model:t,finishReason:s.metadata.finishReason,warnings:s.metadata.warnings,usage:s.metadata.usage,responseStatus:s.metadata.responseStatus,hasResponse:void 0!==s.metadata.responseStatus,latencyMs:s.metadata.latencyMs,responseBodyPreview:s.metadata.responseBodyPreview}),"none"!==s.metadata.fallbackSource&&R.k.log(16,"XAI_RESPONSE_FALLBACK_USED","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,model:t,fallbackSource:s.metadata.fallbackSource}),R.k.log(16,"AI_RESPONSE_OUTPUT","inngest/functions/itinerary.ts","aiItineraryArchitect",{aiResponse:s.rawOutput});let a=s.itinerary??{},o=Array.isArray(a?.travelTips)?a.travelTips.length:0,l=q(a,i),u=JSON.stringify(l,null,2);return R.k.log(16,"AI_ARCHITECT_COMPLETED","inngest/functions/itinerary.ts","aiItineraryArchitect",{workflowId:r,durationMs:Date.now()-n,generatedDays:Array.isArray(l?.dailyPlans)?l.dailyPlans.length:Array.isArray(l?.dailyItinerary)?l.dailyItinerary.length:Array.isArray(l?.days)?l.days.length:0,travelTips:{incomingCount:o,finalCount:Array.isArray(l?.travelTips)?l.travelTips.length:0},reasoningCharacters:0}),{itinerary:l,rawOutput:s.rawOutput,cleanedJson:u}}catch(e){throw R.k.error(17,"AI_ARCHITECT_FAILED","inngest/functions/itinerary.ts","aiItineraryArchitect",e instanceof Error?e:String(e),{workflowId:r}),e}});return await t.run("store-itinerary",async()=>{R.k.log(20,"REDIS_STORAGE_STARTED","inngest/functions/itinerary.ts","storeItinerary",{workflowId:r}),console.log("\uD83D\uDCCB [STORE] Raw JSON string to be saved:",a.cleanedJson);let e=await N.U.storeItineraryState({workflowId:r,sessionId:n,status:"completed",formData:i,itinerary:a.cleanedJson,rawItinerary:a.rawOutput,createdAt:s,updatedAt:new Date().toISOString()});return console.log("\uD83D\uDCBE [STORE] Data stored in Redis:",{workflowId:r,stored:e,itineraryType:typeof a.cleanedJson,hasItinerary:!!a.cleanedJson,itineraryLength:a.cleanedJson?a.cleanedJson.length:0}),R.k.log(19,"STORE_ITINERARY_RESULT","inngest/functions/itinerary.ts","storeItinerary",{workflowId:r,stored:e,hasItinerary:!!a.cleanedJson}),{stored:e}}),await t.run("store-search-data",async()=>{try{let e=await (0,$.Lm)(r,{destination:i.destination,duration:parseInt(i.duration),budget:i.budget,activities:i.activities||[],preferences:i.preferences||[],itinerary:a.itinerary,timestamp:new Date().toISOString()});return R.k.log(20,"SEARCH_DATA_STORAGE_RESULT","inngest/functions/itinerary.ts","storeSearchData",{workflowId:r,searchStored:e}),{searchStored:e}}catch(e){return R.k.error(20,"SEARCH_DATA_STORAGE_FAILED","inngest/functions/itinerary.ts","storeSearchData",e instanceof Error?e:String(e),{workflowId:r}),{searchStored:!1}}}),await t.run("save-file-log",async()=>(R.k.log(19,"AI_OUTPUT_FILE_LOGGING_SKIPPED","inngest/functions/itinerary.ts","saveFileLog",{workflowId:r,reason:"File logging disabled in production environment"}),{fileSaved:!1,reason:"production"})),R.k.log(21,"INNGEST_WORKFLOW_COMPLETED","inngest/functions/itinerary.ts","itineraryWorkflow",{workflowId:r,status:"completed"}),{success:!0,workflowId:r,itinerary:a.cleanedJson}}),{GET:B,POST:W,PUT:G}=(e=>{let t=new k({frameworkName:"nextjs",...e,handler:(t,...i)=>{let[n,r]=i,s=e=>{let t="function"==typeof n.headers.get?n.headers.get(e):n.headers[e];return Array.isArray(t)?t[0]:t};return{body:()=>"function"==typeof n.json?n.json():n.body,headers:s,method:()=>t||n.method||"",isProduction:()=>{try{return!0}catch(e){}},queryString:(e,t)=>{let i=n.query?.[e]||t.searchParams.get(e);return Array.isArray(i)?i[0]:i},url:()=>{let t;try{t=new URL(n.url)}catch{}if(t){let i=e.serveHost||s("host");if(i){let e=new URL(i.includes("://")?i:`${t.protocol}//${i}`);t.protocol=e.protocol,t.host=e.host,t.port=e.port,t.username=e.username,t.password=e.password}return t}let i=e.serveHost||s("host")||"";return new URL(n.url,`https://${i}`)},transformResponse:({body:e,headers:t,status:i})=>{if(x(r)){for(let[e,i]of Object.entries(t))r.setHeader(e,i);r.status(i),r.send(e);return}return new((0,o.ck)())(e,{status:i,headers:t})},transformStreamingResponse:({body:e,headers:t,status:i})=>new Response(e,{status:i,headers:t})}}}).createHandler(),i=t.bind(null,void 0);return Object.defineProperty(i,"length",{value:1}),Object.defineProperties(i,{GET:{value:t.bind(null,"GET")},POST:{value:t.bind(null,"POST")},PUT:{value:t.bind(null,"PUT")}})})({client:O.$C,functions:[F]}),z=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/inngest/route",pathname:"/api/inngest",filename:"route",bundlePath:"app/api/inngest/route"},resolvedPagePath:"C:\\Users\\raze0\\Documents\\vercel_deploy\\hylo00_original\\src\\app\\api\\inngest\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:J,staticGenerationAsyncStorage:H,serverHooks:M}=z,V="/api/inngest/route";function Z(){return(0,a.patchFetch)({serverHooks:M,staticGenerationAsyncStorage:H})}},9303:(e,t,i)=>{e.exports=i(517)},9435:(e,t,i)=>{i.d(t,{$C:()=>o});var n=i(2745),r=i(1202),s=i(2584);let a=null,o=function(){if(a)return a;try{let e=(0,s.e)();return a=new n.K({id:"hylo00-itinerary",name:"Hylo00 AI Itinerary Generator",eventKey:e.inngest.eventKey,signingKey:e.inngest.signingKey,baseUrl:"development"===e.app.nodeEnv?"http://localhost:8288":void 0,logger:{debug:(e,...t)=>{t.length>0?r.k.log(0,`INNGEST_DEBUG: ${e}`,"client.ts","debug",{args:t}):r.k.log(0,`INNGEST_DEBUG: ${e}`,"client.ts","debug")},info:(e,...t)=>{t.length>0?r.k.log(0,`INNGEST_INFO: ${e}`,"client.ts","info",{args:t}):r.k.log(0,`INNGEST_INFO: ${e}`,"client.ts","info")},warn:(e,...t)=>{t.length>0?r.k.log(0,`INNGEST_WARN: ${e}`,"client.ts","warn",{args:t}):r.k.log(0,`INNGEST_WARN: ${e}`,"client.ts","warn")},error:(e,...t)=>{t.length>0?r.k.log(0,`INNGEST_ERROR: ${e}`,"client.ts","error",{args:t}):r.k.log(0,`INNGEST_ERROR: ${e}`,"client.ts","error")}}}),r.k.log(0,"INNGEST_CLIENT_INITIALIZED","client.ts","getInngestClient",{clientId:"hylo00-itinerary",hasEventKey:!!e.inngest.eventKey,hasSigningKey:!!e.inngest.signingKey,isDevelopment:"development"===e.app.nodeEnv}),a}catch(e){throw r.k.error(0,"INNGEST_CLIENT_INITIALIZATION_FAILED","client.ts","getInngestClient",e instanceof Error?e:String(e)),e}}()},8227:(e,t,i)=>{i.d(t,{M:()=>s,y:()=>a});var n=i(1202);let r="https://api.x.ai/v1/chat/completions";function s(e){let t=[],i=e.indicator,n=e.query,r="string"==typeof i&&i.trim()?i:"string"==typeof n&&n.trim()?n:"general";t.push("You are Hylo's AI Itinerary Architect. Craft a detailed, actionable itinerary aligned with the indicator focus."),t.push(`Indicator: ${r}`),t.push(`Destination: ${e.location??"Unknown destination"}`),!0===e.flexibleDates?t.push(`Dates: Flexible, target ${e.plannedDays??"unspecified"} days.`):t.push(`Dates: ${e.departDate??"unspecified"} – ${e.returnDate??"unspecified"}.`);let s=e.adults??1,a=e.children??0;if(a>0){let i=(Array.isArray(e.childrenAges)?e.childrenAges:[]).map(e=>"number"!=typeof e||Number.isNaN(e)?null:e<2?`Infant (${e})`:e<5?`Toddler (${e})`:e<13?`Child (${e})`:e<18?`Teen (${e})`:`Young traveler (${e})`).filter(e=>!!e),n=i.length>0?` Age breakdown: ${i.join(", ")}.`:"";t.push(`Travel party: ${s} adult(s), ${a} child(ren).${n} Keep pacing family-friendly with rest time, flexible dining, and safety cues.`)}else t.push(`Travel party: ${s} adult(s). Trip is adults-only; highlight late-night, intimate, or adventurous options when appropriate.`);!0===e.flexibleBudget?t.push("Budget: Flexible. Offer tiered recommendations (value, mid, premium) when relevant."):"number"==typeof e.budget&&t.push(`Budget: Roughly ${e.currency??"USD"} ${e.budget}. Keep suggestions within range unless an upgrade is justified.`);let o=e.travelStyleAnswers??{},l=[],u=(e,t)=>{Array.isArray(t)&&t.length>0&&l.push(`${e}: ${t.join("; ")}`)};if(u("Experience level",o.experience),u("Desired vibes",o.vibes),u("Ideal day patterns",o.sampleDays),u("Dinner preferences",o.dinnerChoices),Array.isArray(o.vibes)&&o.vibes.includes("other")&&o.vibesOther){let e=l.findIndex(e=>e.startsWith("Desired vibes:"));-1!==e&&(l[e]=l[e].replace("other",o.vibesOther.trim()))}if("string"==typeof o.customVibesText&&o.customVibesText.trim()&&l.push(`Custom vibe notes: ${o.customVibesText.trim()}`),"string"==typeof o.otherDinnerChoiceText&&o.otherDinnerChoiceText.trim()&&l.push(`Custom dining notes: ${o.otherDinnerChoiceText.trim()}`),l.length>0?t.push("Detailed travel style signals:\n"+l.map(e=>`- ${e}`).join("\n")):"answer-questions"===e.travelStyleChoice?t.push("Detailed travel style questionnaire submitted without specific selections; infer from other context."):"skip-to-details"===e.travelStyleChoice&&t.push("Traveler skipped the style questionnaire. Infer tone from core preferences, interests, and inclusions."),Array.isArray(e.selectedGroups)&&e.selectedGroups.length>0){let i=e.selectedGroups.join(", ");e.selectedGroups.includes("other")&&e.customGroupText&&(i=i.replace("other",e.customGroupText.trim())),t.push(`Travel group: ${i}.`)}if(Array.isArray(e.selectedInterests)&&e.selectedInterests.length>0){let i=e.selectedInterests.join(", ");e.selectedInterests.includes("other")&&e.customInterestsText&&(i=i.replace("other",e.customInterestsText.trim())),t.push(`Key interests: ${i}.`)}return Array.isArray(e.selectedInclusions)&&e.selectedInclusions.length>0&&(t.push("Must-have inclusions:"),e.selectedInclusions.forEach(i=>{if("string"==typeof i&&i.trim()){let n=i.trim();"other"===n&&e.customInclusionsText&&(n=e.customInclusionsText.trim()),t.push(`- Ensure planning covers: ${n}`)}})),"string"==typeof e.tripNickname&&e.tripNickname.trim()&&t.push(`Trip nickname: ${e.tripNickname.trim()}. Use this nickname in the intro.`),"string"==typeof e.tripVibe&&e.tripVibe.trim()&&t.push(`Primary vibe: ${e.tripVibe.trim()}. Reinforce this tone throughout.`),e.diningPreferences&&t.push(`Dining preferences: ${JSON.stringify(e.diningPreferences)}.`),e.sampleDays&&t.push(`Ideal day structure: ${JSON.stringify(e.sampleDays)}.`),"string"==typeof e.additionalNotes&&e.additionalNotes.trim()&&t.push(`Traveler notes: ${e.additionalNotes.trim()}`),t.push("Execution requirements:"),t.push("- Produce an intro paragraph that feels concierge-written, 2-3 sentences."),t.push("- Build `dailyPlans` array with one entry per day, preserving date order."),t.push("- Each day must include morning, afternoon, evening anchors with 3+ specific activities each."),t.push("- For each time period (morning/afternoon/evening), provide detailed, actionable activities that create a rich experience."),t.push("- Activities should be varied: mix cultural experiences, local interactions, relaxation, exploration, and unique discoveries."),t.push("- If transportation is required, include `transportation` notes with time estimates."),t.push("- Add `dining` suggestions that match the traveler vibe and any dietary notes."),t.push("- Reference the trip nickname if provided."),t.push("- End with `keyTakeaways` summarizing highlights and a `travelTips` array tailored from the traveler form responses."),t.push("- For `travelTips`, output an array where each item is an object containing `title` and `description` strings with practical, concierge-ready guidance."),t.push("- Do not include a `nextSteps` field—focus on personalized travel tips instead."),t.push("Output requirements: Respond with a single JSON object containing `dailyPlans` where each entry represents one day. Each day should include activities, meals, and transportation details."),t.push(`Form data JSON:
${JSON.stringify(e,null,2)}`),t.join("\n\n")}async function a({prompt:e,model:t="grok-4-fast-reasoning",temperature:i=.7}){let s,a;if(!process.env.XAI_API_KEY)throw Error("XAI_API_KEY is not configured.");let u=Date.now(),c=await fetch(r,{method:"POST",headers:{Authorization:`Bearer ${process.env.XAI_API_KEY}`,"Content-Type":"application/json"},body:JSON.stringify({model:t,messages:[{role:"user",content:e}],temperature:i})}),d=c.status,h=await c.text();if(!c.ok)throw n.k.error(17,"XAI_REQUEST_FAILED","lib/ai/architectAI.ts","generateGrokItineraryDraft","xAI API request failed",{responseStatus:d,responseBody:h.slice(0,1e3),model:t,endpoint:r,promptLength:e.length}),Error(`xAI request failed (${d}): ${h.slice(0,200)}`);try{s=h?JSON.parse(h):{}}catch(e){throw n.k.error(17,"XAI_INVALID_JSON","lib/ai/architectAI.ts","generateGrokItineraryDraft","Failed to parse xAI JSON response",{responseStatus:d,responseBodyPreview:h.slice(0,600)}),Error("Failed to parse xAI JSON response")}let{text:p,fallbackSource:g}=function(e){if(!e)return{text:null,fallbackSource:"none"};let t=e.output??e.outputs;if(Array.isArray(t)){let e=[];for(let i of t){let t=i?.content??i?.contents;if(Array.isArray(t))for(let i of t)"string"==typeof i?.text&&i.text.trim()&&e.push(i.text.trim());else"string"==typeof t?.text&&t.text.trim()&&e.push(t.text.trim())}if(e.length>0)return{text:e.join("\n\n"),fallbackSource:"none"}}let i=o(e?.choices?.[0]?.message?.content);if(i)return{text:i,fallbackSource:"parsed-content"};let n=e?.choices?.[0]?.message?.tool_calls?.[0]?.function?.arguments;if("string"==typeof n&&n.trim())return{text:n,fallbackSource:"tool-call"};if(n&&"object"==typeof n){let e=JSON.stringify(n);if(e.trim())return{text:e,fallbackSource:"tool-call"}}let r=o(e?.choices?.[0]?.message?.reasoning_content);if(r)return{text:r,fallbackSource:"reasoning"};let s=e?.response?.output_text??e?.text;if("string"==typeof s&&s.trim())return{text:s.trim(),fallbackSource:"parsed-content"};let a=o(e);return a?{text:a,fallbackSource:"parsed-content"}:{text:null,fallbackSource:"none"}}(s);if(n.k.log(16,"XAI_RAW_RESULT","lib/ai/architectAI.ts","generateGrokItineraryDraft",{finishReason:l(s),warnings:s?.warnings,usage:s?.usage,hasText:!!p?.trim?.(),responseKeys:s?Object.keys(s):null}),!p||!p.trim()){if(s?.error?.message)throw Error(`xAI error: ${s.error.message}`);throw n.k.error(17,"XAI_EMPTY_RESPONSE","lib/ai/architectAI.ts","generateGrokItineraryDraft","xAI returned empty text after parsing",{responseStatus:d,responseBodyPreview:h.slice(0,600),parsedKeys:s?Object.keys(s):null}),Error("xAI returned empty text")}let y=function(e){if(!e||!e.trim())throw Error("AI response was empty");let t=e.match(/```json([\s\S]*?)```/i)||e.match(/```([\s\S]*?)```/i),i=t?t[1]:e,n=[i.indexOf("{"),i.indexOf("[")].filter(e=>e>=0),r=[i.lastIndexOf("}"),i.lastIndexOf("]")].filter(e=>e>=0);if(0===n.length||0===r.length)throw Error("Unable to locate JSON payload in AI response");let s=Math.min(...n),a=Math.max(...r);if(!Number.isFinite(s)||!Number.isFinite(a)||s<0||a<s)throw Error("Unable to locate JSON payload in AI response");return i.slice(s,a+1).trim()}(p);try{a=JSON.parse(y)}catch(e){throw Error("Failed to parse Grok itinerary JSON")}return{rawOutput:p,cleanedJson:y,itinerary:a,metadata:{model:t,latencyMs:Date.now()-u,finishReason:l(s),usage:function(e){if(!e||"object"!=typeof e)return;let t={};if("number"==typeof e.input_tokens&&(t.promptTokens=e.input_tokens),"number"==typeof e.output_tokens&&(t.completionTokens=e.output_tokens),"number"==typeof e.total_tokens&&(t.totalTokens=e.total_tokens),0!==Object.keys(t).length)return t}(s?.usage),warnings:s?.warnings,responseStatus:d,responseBodyPreview:h.slice(0,600),fallbackSource:g}}}function o(e){if(!e)return null;if("string"==typeof e)return e.trim()||null;if(Array.isArray(e)){let t=e.map(e=>o(e)).filter(e=>!!e);return t.length>0?t.join(" ").trim():null}if("object"==typeof e){if(null===e)return null;if("string"==typeof e.text)return e.text.trim()||null;if("string"==typeof e.content)return e.content.trim()||null;try{let t=JSON.stringify(e);return t.trim()?t:null}catch{}}return null}function l(e){return e?.output?.[0]?.finish_reason??e?.output?.[0]?.stopReason??e?.finish_reason??e?.finishReason}},6288:(e,t,i)=>{i.d(t,{Lm:()=>o,Pg:()=>l});var n=i(6343),r=i(1202);let s=null;function a(){if(!s){let e=process.env.KV_REST_API_URL,t=process.env.KV_REST_API_TOKEN;if(!e||!t)throw r.k.error(0,"REDIS_CONFIG_MISSING","redis-vector.ts","getRedisClient","Missing Redis credentials"),Error("Missing KV_REST_API_URL or KV_REST_API_TOKEN");s=new n.s({url:e,token:t}),r.k.log(0,"REDIS_VECTOR_CLIENT_INITIALIZED","redis-vector.ts","getRedisClient")}return s}async function o(e,t){try{let i=a(),n=[t.destination.toLowerCase(),`${t.duration} days`,t.budget.toLowerCase(),...t.activities.map(e=>e.toLowerCase()),...t.preferences.map(e=>e.toLowerCase())].join(" "),s=`search:${e}`;await i.hset(s,{workflowId:e,destination:t.destination,duration:t.duration,budget:t.budget,activities:JSON.stringify(t.activities),preferences:JSON.stringify(t.preferences),searchText:n,timestamp:t.timestamp,itinerary:JSON.stringify(t.itinerary)});let o=i.pipeline();o.sadd(`idx:destination:${t.destination.toLowerCase()}`,e),o.sadd(`idx:budget:${t.budget.toLowerCase()}`,e);let l=u(t.duration);return o.sadd(`idx:duration:${l}`,e),t.activities.forEach(t=>{o.sadd(`idx:activity:${t.toLowerCase()}`,e)}),o.sadd("idx:all",e),await o.exec(),r.k.log(201,"ITINERARY_SEARCH_DATA_STORED","redis-vector.ts","storeItineraryForSearch",{workflowId:e,destination:t.destination}),!0}catch(t){return r.k.error(202,"ITINERARY_SEARCH_STORE_FAILED","redis-vector.ts","storeItineraryForSearch",t instanceof Error?t:String(t),{workflowId:e}),!1}}async function l(e,t=5){try{let i;let n=a(),s=[];if(e.destination&&s.push(`idx:destination:${e.destination.toLowerCase()}`),e.budget&&s.push(`idx:budget:${e.budget.toLowerCase()}`),e.duration){let t=u(e.duration);s.push(`idx:duration:${t}`)}if(e.activities&&e.activities.length>0&&e.activities.forEach(e=>{s.push(`idx:activity:${e.toLowerCase()}`)}),0===s.length)i=await n.smembers("idx:all");else if(1===s.length)i=await n.smembers(s[0]);else{let e=await Promise.all(s.map(e=>n.smembers(e)));i=e.length>0?e[0].filter(t=>e.every(e=>e.includes(t))):[]}let o=[];for(let r of i.slice(0,t)){let t=await n.hgetall(`search:${r}`);t&&Object.keys(t).length>0&&o.push({id:r,score:function(e,t){let i,n=0;if(i=.4,e.destination&&t.destination&&t.destination.toLowerCase().includes(e.destination.toLowerCase())&&(n+=.4),i+=.3,e.budget&&t.budget&&t.budget.toLowerCase()===e.budget.toLowerCase()&&(n+=.3),i+=.2,e.duration&&t.duration){let i=Math.abs(e.duration-parseInt(t.duration));0===i?n+=.2:i<=2&&(n+=.1)}if(i+=.1,e.activities&&t.activities){let i=e.activities.map(e=>e.toLowerCase()),r=JSON.parse(t.activities).map(e=>e.toLowerCase()),s=i.filter(e=>r.includes(e)).length;s>0&&(n+=s/Math.max(i.length,r.length)*.1)}return i>0?n/i:0}(e,t),metadata:{destination:t.destination,duration:parseInt(t.duration),budget:t.budget,activities:JSON.parse(t.activities),preferences:JSON.parse(t.preferences),timestamp:t.timestamp,itinerary:JSON.parse(t.itinerary)}})}return o.sort((e,t)=>t.score-e.score),r.k.log(203,"SIMILAR_ITINERARIES_FOUND","redis-vector.ts","searchSimilarItineraries",{resultsCount:o.length,topK:t}),o.slice(0,t)}catch(e){return r.k.error(204,"SIMILAR_ITINERARIES_SEARCH_FAILED","redis-vector.ts","searchSimilarItineraries",e instanceof Error?e:String(e)),[]}}function u(e){return e<=3?"short":e<=7?"week":e<=14?"long":"extended"}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),n=t.X(0,[948,343,745,671],()=>i(7354));module.exports=n})();