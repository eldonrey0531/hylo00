"use strict";exports.id=671,exports.ids=[671],exports.modules={2584:(t,e,r)=>{r.d(e,{e:()=>n});var i=r(1202);let a=null;function n(){if(a)return a;try{return i.k.log(23,"Loading itinerary configuration","itinerary-config.ts","getItineraryConfig"),function(){let t=["GROQ_API_KEY","XAI_API_KEY","TAVILY_API_KEY","EXA_API_KEY","SERP_API_KEY","INNGEST_EVENT_KEY","INNGEST_SIGNING_KEY","KV_REST_API_URL","KV_REST_API_TOKEN"].filter(t=>!process.env[t]);if(t.length>0){let e=`Missing environment variables (using fallbacks): ${t.join(", ")}`;i.k.error(23,"Configuration validation failed","itinerary-config.ts","validateRequiredEnvVars",e)}else i.k.log(23,"Required environment variables validated","itinerary-config.ts","validateRequiredEnvVars")}(),a={groq:{apiKey:process.env.GROQ_API_KEY},xai:{apiKey:process.env.XAI_API_KEY},tavily:{apiKey:process.env.TAVILY_API_KEY},exa:{apiKey:process.env.EXA_API_KEY},serp:{apiKey:process.env.SERP_API_KEY},inngest:{eventKey:process.env.INNGEST_EVENT_KEY,signingKey:process.env.INNGEST_BRANCH_SIGNING_KEY||process.env.INNGEST_SIGNING_KEY},redis:{restUrl:process.env.KV_REST_API_URL,restToken:process.env.KV_REST_API_TOKEN},app:{nodeEnv:function(t){let e="development";return t&&["development","preview","production"].includes(t)?t:(i.k.warn(23,"Invalid NODE_ENV, using default","itinerary-config.ts","parseNodeEnv",`Invalid value: ${t}, using: ${e}`),e)}("production"),logLevel:function(t){let e="info";return t&&["silent","error","warn","info","debug"].includes(t)?t:(i.k.warn(23,"Invalid ITINERARY_LOG_LEVEL, using default","itinerary-config.ts","parseLogLevel",`Invalid value: ${t}, using: ${e}`),e)}(process.env.ITINERARY_LOG_LEVEL),cacheTtlMinutes:function(t){if(!t)return 120;let e=parseInt(t,10);return isNaN(e)||e<5||e>1440?(i.k.warn(23,"Invalid ITINERARY_CACHE_TTL_MINUTES, using default","itinerary-config.ts","parseCacheTtl",`Invalid value: ${t}, using: 120`),120):e}(process.env.ITINERARY_CACHE_TTL_MINUTES)},flags:{enableDetailedLogging:!0,enableDataCleansing:!0,allowPdfExport:!0,allowEmailDraft:!0,mapsFallbackMode:function(t){let e="static";return t&&["static","placeholder","hidden"].includes(t)?t:(i.k.warn(23,"Invalid maps fallback mode, using default","itinerary-config.ts","parseMapsFallbackMode",`Invalid value: ${t}, using: ${e}`),e)}(process.env.ITINERARY_MAPS_FALLBACK_MODE)}},i.k.log(23,"Itinerary configuration loaded successfully","itinerary-config.ts","getItineraryConfig",{nodeEnv:a.app.nodeEnv,logLevel:a.app.logLevel,cacheTtlMinutes:a.app.cacheTtlMinutes,mapsFallbackMode:a.flags.mapsFallbackMode}),a}catch(t){throw i.k.error(23,"Failed to load itinerary configuration","itinerary-config.ts","getItineraryConfig",t instanceof Error?t:String(t)),t}}},3671:(t,e,r)=>{r.d(e,{U:()=>u});var i=r(6343),a=r(1202),n=r(2584),s=r(2048),o=r(5315);class l{redis=null;initialized=!1;constructor(){this.initialize()}initialize(){try{let t=(0,n.e)();if(!t.redis.restUrl||!t.redis.restToken){a.k.warn(0,"REDIS_CONFIG_MISSING","stateStore.ts","initialize","Redis configuration incomplete, using mock mode",{hasRestUrl:!!t.redis.restUrl,hasRestToken:!!t.redis.restToken});return}this.redis=new i.s({url:t.redis.restUrl,token:t.redis.restToken}),this.initialized=!0,a.k.log(0,"REDIS_CLIENT_INITIALIZED","stateStore.ts","initialize",{restUrlConfigured:!!t.redis.restUrl})}catch(t){a.k.error(0,"REDIS_INITIALIZATION_FAILED","stateStore.ts","initialize",t instanceof Error?t:String(t))}}async storeItineraryState(t){let e=`itinerary:${t.workflowId}`,r=Date.now();console.log("\uD83D\uDCBE [STORE] Storing itinerary state:",{workflowId:t.workflowId,status:t.status,hasItinerary:!!t.itinerary,hasLayout:!!t.layout,hasLayoutContent:!!t.layout?.content,itineraryType:typeof t.itinerary,layoutContentType:t.layout?.content?typeof t.layout.content:"undefined",dailyCount:t.layout?.content?.daily?.length,introLength:t.layout?.content?.intro?.body?.length});try{let i={...t,createdAt:t.createdAt??new Date().toISOString(),updatedAt:new Date().toISOString()};if(this.initialized&&this.redis){await this.redis.set(e,i);let n="completed"===t.status||"error"===t.status?604800:86400;return await this.redis.expire(e,n),a.k.log(102,"ITINERARY_STATE_STORED","stateStore.ts","storeItineraryState",{workflowId:t.workflowId,status:t.status,durationMs:Date.now()-r,ttlSeconds:n,storage:"redis"}),!0}return a.k.log(102,"ITINERARY_STATE_STORED_REDIS_ONLY","stateStore.ts","storeItineraryState",{workflowId:t.workflowId,status:t.status,durationMs:Date.now()-r,storage:"redis-only"}),!0}catch(e){return a.k.error(103,"ITINERARY_STATE_STORE_FAILED","stateStore.ts","storeItineraryState",e instanceof Error?e:String(e),{workflowId:t.workflowId,status:t.status}),!1}}async getItineraryState(t){let e=`itinerary:${t}`,r=Date.now();try{if(this.initialized&&this.redis){let i=await this.redis.get(e);if(!i)return a.k.log(105,"ITINERARY_STATE_NOT_FOUND","stateStore.ts","getItineraryState",{workflowId:t,durationMs:Date.now()-r,storage:"redis"}),null;let n="string"==typeof i?JSON.parse(i):i;return console.log("\uD83D\uDCE5 [RETRIEVE] Retrieved itinerary state:",{workflowId:t,status:n.status,hasItinerary:!!n.itinerary,hasLayout:!!n.layout,hasLayoutContent:!!n.layout?.content,itineraryType:typeof n.itinerary,layoutContentType:n.layout?.content?typeof n.layout.content:"undefined",dailyCount:n.layout?.content?.daily?.length,introLength:n.layout?.content?.intro?.body?.length,rawDataKeys:Object.keys(n),layoutKeys:n.layout?Object.keys(n.layout):[],storage:"redis"}),a.k.log(106,"ITINERARY_STATE_RETRIEVED","stateStore.ts","getItineraryState",{workflowId:t,status:n.status,durationMs:Date.now()-r,storage:"redis"}),n}return a.k.log(105,"ITINERARY_STATE_NOT_FOUND_REDIS_ONLY","stateStore.ts","getItineraryState",{workflowId:t,durationMs:Date.now()-r,storage:"redis-only"}),null}catch(e){return a.k.error(107,"ITINERARY_STATE_RETRIEVE_FAILED","stateStore.ts","getItineraryState",e instanceof Error?e:String(e),{workflowId:t}),null}}async clearItineraryState(t){let e=`itinerary:${t}`,r=!1;try{this.initialized&&this.redis&&await this.redis.exists(e)&&(await this.redis.del(e),a.k.log(109,"ITINERARY_STATE_CLEARED_FROM_REDIS","stateStore.ts","clearItineraryState",{workflowId:t}),r=!0);let i=o.join(process.cwd(),"state"),n=o.join(i,`${t}.json`);return s.existsSync(n)&&(s.unlinkSync(n),a.k.log(109,"ITINERARY_STATE_CLEARED_FROM_FILE","stateStore.ts","clearItineraryState",{workflowId:t,filePath:n}),r=!0),r}catch(e){return a.k.error(110,"ITINERARY_STATE_CLEAR_FAILED","stateStore.ts","clearItineraryState",e instanceof Error?e:String(e),{workflowId:t}),!1}}async updateItineraryStatus(t,e,r){let i=await this.getItineraryState(t);if(!i)return a.k.warn(109,"ITINERARY_STATE_UPDATE_FAILED_NO_EXISTING","stateStore.ts","updateItineraryStatus","No existing state found",{workflowId:t,newStatus:e}),!1;a.k.log(111,"ITINERARY_STATUS_UPDATE_ATTEMPT","stateStore.ts","updateItineraryStatus",{workflowId:t,currentStatus:i.status,newStatus:e});let n={...i,status:e,...r&&{error:r},updatedAt:new Date().toISOString()},s=await this.storeItineraryState(n);return a.k.log(112,"ITINERARY_STATUS_UPDATE_RESULT","stateStore.ts","updateItineraryStatus",{workflowId:t,success:s,finalStatus:e}),s}async setCache(t,e,r=60){if(!this.initialized||!this.redis)return a.k.warn(109,"REDIS_NOT_INITIALIZED","stateStore.ts","setCache","Redis not available, skipping cache",{key:t,ttlMinutes:r}),!1;let i=`cache:${t}`,n=Date.now();try{let s={data:e,expiresAt:Date.now()+6e4*r,createdAt:new Date().toISOString()};return await this.redis.set(i,JSON.stringify(s)),await this.redis.expire(i,60*r),a.k.log(110,"CACHE_ENTRY_STORED","stateStore.ts","setCache",{key:t,ttlMinutes:r,durationMs:Date.now()-n}),!0}catch(e){return a.k.error(111,"CACHE_STORE_FAILED","stateStore.ts","setCache",e instanceof Error?e:String(e),{key:t,ttlMinutes:r}),!1}}async getCache(t){if(!this.initialized||!this.redis)return a.k.warn(112,"REDIS_NOT_INITIALIZED","stateStore.ts","getCache","Redis not available, returning null",{key:t}),null;let e=`cache:${t}`,r=Date.now();try{let i=await this.redis.get(e);if(!i)return a.k.log(113,"CACHE_MISS","stateStore.ts","getCache",{key:t,durationMs:Date.now()-r}),null;let n=JSON.parse(i);if(Date.now()>n.expiresAt)return a.k.log(114,"CACHE_EXPIRED","stateStore.ts","getCache",{key:t,durationMs:Date.now()-r}),await this.redis.del(e),null;return a.k.log(115,"CACHE_HIT","stateStore.ts","getCache",{key:t,durationMs:Date.now()-r}),n.data}catch(e){return a.k.error(116,"CACHE_RETRIEVE_FAILED","stateStore.ts","getCache",e instanceof Error?e:String(e),{key:t}),null}}async deleteCache(t){if(!this.initialized||!this.redis)return a.k.warn(117,"REDIS_NOT_INITIALIZED","stateStore.ts","deleteCache","Redis not available, skipping delete",{key:t}),!1;let e=`cache:${t}`,r=Date.now();try{return await this.redis.del(e),a.k.log(118,"CACHE_DELETED","stateStore.ts","deleteCache",{key:t,durationMs:Date.now()-r}),!0}catch(e){return a.k.error(119,"CACHE_DELETE_FAILED","stateStore.ts","deleteCache",e instanceof Error?e:String(e),{key:t}),!1}}async healthCheck(){if(!this.initialized||!this.redis)return{healthy:!1,message:"Redis client not initialized"};try{let t=await this.redis.ping();return{healthy:"PONG"===t,message:"PONG"===t?"Redis connection healthy":"Redis ping failed"}}catch(t){return{healthy:!1,message:`Redis health check failed: ${t instanceof Error?t.message:String(t)}`}}}}let u=new l},1202:(t,e,r)=>{var i,a,n,s,o;r.d(e,{k:()=>u}),function(t){t.USD="USD",t.EUR="EUR",t.GBP="GBP",t.CAD="CAD",t.AUD="AUD"}(i||(i={})),function(t){t.TOTAL="total",t.PER_PERSON="per-person"}(a||(a={})),function(t){t.PENDING="pending",t.PROCESSING="processing",t.COMPLETE="complete",t.ERROR="error"}(n||(n={})),function(t){t.SUCCESS="Success",t.ERROR="Error",t.WARNING="Warning"}(s||(s={})),function(t){t.HIGH="High",t.MEDIUM="Medium",t.LOW="Low"}(o||(o={}));class l{static instance;logLevel;logs=[];maxLogs=1e3;constructor(){this.logLevel=process.env.ITINERARY_LOG_LEVEL||"info"}static getInstance(){return l.instance||(l.instance=new l),l.instance}shouldLog(t){let e=["silent","error","warn","info","debug"],r=e.indexOf(this.logLevel);return e.indexOf(t)<=r}log(t,e,r,i,a={},n,o=s.SUCCESS){if(!this.shouldLog("info"))return;let l={stepNumber:t,action:e,fileName:r,functionName:i,timestamp:new Date().toISOString(),data:a,...void 0!==n&&{duration:n},status:o};this.logs.push(l),this.logs.length>this.maxLogs&&this.logs.shift();try{console.log(`Step ${t}: ${e} in ${r} - ${i}`,l)}catch(r){console.error(`Step ${t}: Logging failed for ${e}`,{error:r instanceof Error?r.message:String(r)})}}error(t,e,r,i,a,n={}){if(!this.shouldLog("error"))return;let o=a instanceof Error?a.message:a;this.log(t,e,r,i,{...n,error:o},void 0,s.ERROR)}warn(t,e,r,i,a,n={}){this.shouldLog("warn")&&this.log(t,e,r,i,{...n,warning:a},void 0,s.WARNING)}debug(t,e,r,i,a={}){this.shouldLog("debug")&&this.log(t,`DEBUG: ${e}`,r,i,a,void 0,s.SUCCESS)}getLogs(){return[...this.logs]}clearLogs(){this.logs=[]}}let u=l.getInstance()}};